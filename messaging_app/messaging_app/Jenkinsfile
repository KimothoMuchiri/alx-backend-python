pipeline {
    // 1. Define the agent to run the entire pipeline
    agent any

    // 2. Define environment variables (optional but good practice)
    environment {
        // The ID of the credential we created for GitHub
        GITHUB_CREDENTIAL_ID = 'alx-pat-messenger-app'
        
    }

    stages {
        stage('Checkout Code') {
            steps {
                // The 'checkout scm' step uses the repository URL defined in the Jenkins job configuration.
                // It securely uses the GitHub credentials you created.
                checkout([$class: 'GitSCM', 
                        branches: [[name: '*/main']], 
                        userRemoteConfigs: [[
                            url: 'https://github.com/KimothoMuchiri/alx-backend-python.git', // <<< REPLACE THIS
                            credentialsId: env.GITHUB_CREDENTIAL_ID
                        ]]])
            }
        }

        stage('Run Tests and Linting') {
            // Run this stage inside a consistent Python environment
            agent any //{
                //docker { image 'python:3.9-slim' } 
            //}
            steps {
                dir('messaging_app'){
                    sh '''#!/usr/bin/env bash
                      set -euo pipefail
                      python3 -m venv .venv
                      source .venv/bin/activate
                      python -m pip install --upgrade pip
                      python -m pip install -r requirements.txt
                      echo "Installing testing tools..."
                      python -m pip install pytest
                      echo "Running tests..."
                      python -m pytest --junitxml=test-results.xml
                    '''
                } 
            }
        }

        stage('Publish Report') {
            // This stage runs on the main agent to use the JUnit plugin installed on Jenkins
            agent any 
            steps {
                sh 'echo "Publishing test results..."'
                // The JUnit step reads the XML file and creates a visible report in Jenkins
                junit 'test-results.xml'
            }
        }

        stage('Build Docker Image') {
            agent {
                // Use a standard Docker agent since we are running Docker commands
                docker { image 'python:3.9-slim' } 
            }
            steps {
                sh 'cd messaging_app'
                // Build the image, tagging it with your Docker Hub username and a build number
                script {
                    def imageTag = "elcoder062/messaging-app:${env.BUILD_NUMBER}" // <<< REPLACE USERNAME
                    
                    // Assuming your Dockerfile is in the 'messaging_app' directory:
                    sh "docker build -t ${imageTag} ." 
                }
            }
        }

        stage('Push Docker Image') {
            agent {
                docker { image 'python:3.9-slim' }
            }
            steps {
                sh 'cd messaging_app'
                // Use the withCredentials block to securely expose Docker Hub credentials
                withCredentials([usernamePassword(
                    credentialsId: 'docker_cli', // <<< MUST MATCH YOUR ID
                    passwordVariable: 'DOCKER_PASSWORD', 
                    usernameVariable: 'DOCKER_USERNAME')]) {
                    
                    // Log in to Docker Hub using the masked environment variables
                    sh "docker login -u ${env.DOCKER_USERNAME} -p ${env.DOCKER_PASSWORD}"
                    
                    def imageTag = "elcoder062/messaging-app:${env.BUILD_NUMBER}" // <<< REPLACE USERNAME
                    
                    // Push the tagged image
                    sh "docker push ${imageTag}"
                }
            }
        }
    
    }
    
    // 3. Define post-build actions (optional, runs regardless of success/failure)
    post {
        always {
            echo 'Pipeline finished. Check test results for details.'
        }
    }
}