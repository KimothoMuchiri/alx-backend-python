pipeline {
    agent any

    environment {
        // Credentials IDs in Jenkins
        GITHUB_CREDENTIAL_ID = 'alx-pat-messenger-app'
        DOCKER_CRED_ID       = 'docker_cli'

        // Your Docker image repo (change if needed)
        DOCKER_IMAGE_REPO    = 'elcoder062/messaging-app'
    }

    stages {
        stage('Checkout Code') {
            steps {
                checkout([$class: 'GitSCM',
                    branches: [[name: '*/main']],
                    userRemoteConfigs: [[
                        url: 'https://github.com/KimothoMuchiri/alx-backend-python.git',
                        credentialsId: env.GITHUB_CREDENTIAL_ID
                    ]]
                ])
            }
        }

        stage('Run Tests and Linting') {
            agent any
            steps {
                dir('messaging_app') {
                    sh '''#!/usr/bin/env bash
                    set -euo pipefail
                    python3 -m venv .venv
                    source .venv/bin/activate
                    python -m pip install --upgrade pip
                    python -m pip install -r requirements.txt
                    echo "Installing testing tools..."
                    python -m pip install pytest
                    echo "Running tests..."
                    python -m pytest --junitxml=test-results.xml
                    '''
                }
            }
        }

        stage('Publish Report') {
            agent any
            steps {
                sh 'echo "Publishing test results..."'
                // IMPORTANT: file is inside messaging_app/
                junit 'messaging_app/test-results.xml'
            }
        }

        stage('Build Docker Image') {
            // Use the Jenkins node's Docker (not the python container)
            agent any
            steps {
                dir('messaging_app') {
                    script {
                        // SAFE in declarative: mutate env.* inside script{}
                        env.IMAGE_TAG = "${env.DOCKER_IMAGE_REPO}:${env.BUILD_NUMBER}"
                        sh "docker build -t ${env.IMAGE_TAG} ."
                    }
                }
            }
        }

        stage('Push Docker Image') {
            agent any
            steps {
                dir('messaging_app') {
                    script {
                        withCredentials([usernamePassword(
                            credentialsId: env.DOCKER_CRED_ID,
                            usernameVariable: 'DOCKER_USERNAME',
                            passwordVariable: 'DOCKER_PASSWORD'
                        )]) {
                            // Use password-stdin to avoid exposing secrets
                            sh 'echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin'
                            sh "docker push ${env.IMAGE_TAG}"
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            echo 'Pipeline finished. Check test results for details.'
        }
    }
}
